# MADMEDSALES v5.7 작업지시서

> **작성일**: 2026-02-26
> **선행 완료**: v5.6 (커밋 38ff43b) — 비급여표 태깅, 장비 필터링, OCR, 스마트 정렬, 사전 v1.3
> **목표**: OCR을 프로덕션 파이프라인에 통합하고, 49개 병원 전체 배치를 실행하여 Phase 2(세일즈 앵글 매칭)에 필요한 완성 데이터셋을 확보한다.

---

## 작업 순서 및 의존관계

```
작업 1: OCR 통합 (recrawl-v5.ts)
    ↓
작업 2: 49개 병원 전체 배치 실행
    ↓
작업 3: 사전 v1.4 보강 (미등록 장비 분석)
    ↓
작업 4: Phase 2 — TORR RF 세일즈 앵글 매칭
```

---

## 작업 1: OCR → recrawl-v5.ts 프로덕션 통합

### 배경
v5.6 작업 3에서 `_test-v56-multi.ts`에 `--ocr` 플래그로 OCR을 구현했다.
닥터스피부과신사에서 시술 1건→129건(+128)의 극적 효과를 확인했다.
그러나 이 기능은 테스트 스크립트에만 있고, 실제 배치 파이프라인(`recrawl-v5.ts`)에는 미통합 상태다.

### 변경 대상 파일
- `scripts/recrawl-v5.ts` (메인 파이프라인)

### 구현 요구사항

1. **`_test-v56-multi.ts`의 OCR 관련 코드를 `recrawl-v5.ts`에 이식**
   - `captureScreenshots()` 함수 임포트 또는 이식
   - Playwright 브라우저 초기화/종료 로직 추가
   - `closeBrowser()` 호출 보장 (에러 시에도 finally에서 실행)

2. **OCR 활성화 조건 설계**
   - CLI 플래그: `--ocr` (기본 off, 명시적 활성화)
   - 스냅샷 내 URL에서 라이브 스크린샷 촬영 (최대 10 URL × 5장 = 50장 상한)
   - 이미지를 Gemini API parts에 첨부

3. **프롬프트 확장**
   - 이미지 분석 지시 프롬프트를 Gemini 호출 시 추가 (테스트 스크립트와 동일)
   - 텍스트 + 이미지 멀티모달 입력 구성

4. **비용/성능 제어**
   - 이미지 토큰 오버헤드 모니터링: 기존 대비 +10~15% 예상
   - 타임아웃 조정: 스크린샷 촬영에 URL당 최대 10초 제한

### 검증 기준
- 닥터스피부과신사: `recrawl-v5.ts --ocr`로 실행 시 시술 49건 이상 추출
- OCR 없이 실행한 기존 결과와 비교하여 퇴행 없음 확인
- Playwright 브라우저가 정상 종료되는지 확인 (좀비 프로세스 방지)

---

## 작업 2: 49개 병원 전체 배치 실행

### 배경
v5.6까지 톡스앤필강서, 닥터스피부과신사, 바노바기피부과 3곳만 테스트했다.
MADMEDSALES의 타겟은 49개 병원이며, Phase 2 세일즈 앵글 매칭에 전체 데이터셋이 필요하다.

### 실행 계획

1. **배치 실행 (OCR 모드)**
   - `recrawl-v5.ts`로 49개 병원 순차 실행
   - `--ocr` 플래그 활성화
   - 실행 환경: Contabo VPS (Firecrawl 셀프호스팅)

2. **결과 수집 및 품질 점검**
   - 병원별 JSON 출력 → `output/` 디렉토리에 저장
   - 병원별 추출 현황 요약 리포트 자동 생성:
     - 시술 수, 가격 수, 장비 수(매칭/미매칭), 의사 수
     - JSON 잘림 발생 여부 및 복구 성공 여부
     - source 분포 (website / nongeubyeo / page)
   - 가격 0건 병원 → 가격 미공개 사이트인지, 크롤링 실패인지 구분

3. **에러 핸들링**
   - 크롤링 실패 병원: 재시도 1회 → 여전히 실패 시 로그 기록 후 스킵
   - Gemini API 오류 (429 rate limit 등): 지수 백오프 재시도
   - JSON 잘림: `repairTruncatedJson()` 자동 적용

4. **결과물**
   - `output/v57-batch-summary.json` — 49개 병원 전체 요약 통계
   - `output/v57-unmatched-devices.json` — 미등록 장비 목록 (작업 3 입력)

### 검증 기준
- 49개 중 45개 이상 정상 처리 (90%+)
- 평균 시술 추출: 50건 이상/병원
- JSON 복구 실패 0건

---

## 작업 3: 사전 v1.4 보강 — 미등록 장비 빈도 분석

### 배경
v5.6 검증에서 닥터스피부과신사의 장비 매칭률이 43%(46/106)로 미등록 60건이 있었다.
49개 병원 전체 배치 후에는 미등록 장비가 수백 건 나올 수 있다.
반복 출현하는 장비를 사전에 추가하면 전체 매칭률을 크게 올릴 수 있다.

### 구현 요구사항

1. **미등록 장비 빈도 분석**
   - `output/v57-unmatched-devices.json`에서 장비명별 출현 병원 수 집계
   - 2개 이상 병원에서 출현한 장비 = 사전 추가 후보

2. **사전 업데이트**
   - `MADMEDSALES_dictionary_v1.4.json` 생성
   - 후보 장비를 카테고리 분류 후 추가
   - aliases 설정 (한글/영문/약어 변형 포함)

3. **dictionary-loader.ts 경로 업데이트**
   - v1.3 → v1.4

### 검증 기준
- 전체 병원 평균 장비 매칭률 60% 이상 (v1.3 대비 +15%p 이상)
- 미등록 장비 중 3개 이상 병원에서 출현한 것은 전부 추가 완료

---

## 작업 4: Phase 2 — TORR RF 세일즈 앵글 매칭

### 배경
MADMEDSALES의 최종 목표는 병원 프로파일링 데이터를 기반으로 TORR RF 영업 전략을 자동 생성하는 것이다.
Phase 1(데이터 수집)이 작업 1~3에서 완료되면, Phase 2에서 수집된 데이터를 분석하여 병원별 맞춤 세일즈 앵글을 매칭한다.

### 2-Phase 파이프라인 구조

```
Phase 1: OCR → 크롤링 → Gemini 분류 (작업 1~3에서 완료)
    ↓ 병원별 JSON 데이터
Phase 2: 4축 프로파일링 → 5카테고리 세일즈 앵글 매칭 (이 작업)
```

### 4축 병원 프로파일링 (Hospital Scoring)

각 병원을 아래 4개 축으로 0~100 점수화:

| 축 | 측정 기준 | 데이터 소스 |
|---|---|---|
| **Investment (투자성향)** | 고가 장비 보유 수, 최신 장비 비율, 장비 다양성 | medical_devices |
| **Portfolio (시술 포트폴리오)** | 시술 종류 수, RF/리프팅 관련 시술 비중, 가격대 | treatments |
| **Scale (규모)** | 의사 수, 지점 수, 시술 가격 총량 | doctors, basic_info |
| **Marketing (마케팅 활동)** | SNS 활성도, 이벤트 가격 비중, 웹사이트 완성도 | contact_info, treatments(이벤트) |

### 5카테고리 TORR RF 세일즈 앵글

| 카테고리 | 타겟 병원 특성 | 핵심 메시지 |
|---|---|---|
| **업그레이드** | 구형 RF 장비 보유 (예: Thermage FLX 이전 모델) | "기존 장비 대비 시술 시간 50% 단축" |
| **포트폴리오 확장** | RF 장비 미보유, 리프팅 시술은 있음 | "리프팅 라인업에 RF를 추가하세요" |
| **프리미엄 포지셔닝** | 고가 시술 중심, 투자성향 높음 | "최고급 RF로 프리미엄 가격 정당화" |
| **비용 효율** | 중소규모, 가격 경쟁 중 | "회당 소모품 비용 절감으로 마진 개선" |
| **신규 도입** | 개원 초기 또는 장비 적음 | "첫 RF 장비로 검증된 TORR RF" |

### 구현 요구사항

1. **스코어링 엔진 구현**
   - 입력: 병원별 JSON (Phase 1 출력)
   - 출력: 4축 점수 (0~100) + 종합 등급 (S/A/B/C)

2. **세일즈 앵글 매칭 로직**
   - 4축 점수 조합으로 5카테고리 중 최적 1~2개 매칭
   - 매칭 근거 텍스트 자동 생성 (예: "Thermage CPT 보유 → 업그레이드 앵글")

3. **최종 출력**
   - `output/v57-sales-report.json` — 49개 병원별 프로파일 + 세일즈 앵글
   - 병원별 1-page 영업 브리핑 자동 생성 가능 구조

### 검증 기준
- 49개 병원 전체 스코어링 완료
- 세일즈 앵글 미매칭 0건 (모든 병원에 최소 1개 앵글 배정)
- 테스트 병원 3곳(톡스앤필강서, 닥터스피부과신사, 바노바기) 결과를 수동 검토하여 앵글 적합성 확인

---

## 인프라 참고사항

- **Gemini API**: 2.5 Flash 사용 (비용: ₩700/1000 items)
- **크롤링 서버**: Contabo VPS + Firecrawl 셀프호스팅 (플랜/리전/월비용 재확인 필요)
- **Playwright**: OCR 스크린샷용 — 배치 실행 시 메모리 모니터링 필요
- **Supabase**: 결과 저장 시 3개 프로젝트 공유 DB 구조 주의 (스키마 정리 미완)

---

## 완료 조건 체크리스트

- [ ] 작업 1: `recrawl-v5.ts --ocr` 작동 확인
- [ ] 작업 2: 49개 병원 배치 실행 완료 (90%+ 성공률)
- [ ] 작업 3: 사전 v1.4 생성, 매칭률 60%+ 달성
- [ ] 작업 4: 49개 병원 세일즈 앵글 매칭 완료
- [ ] 전체 결과 git push
